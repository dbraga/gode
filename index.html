<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Gode</title>
  </head>
  <body>


  <script type="text/javascript" src="media/jquery-1.8.3.min.js"></script>
  <script src="media/d3.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>


  <script>
    var socket = io.connect('http://localhost:3000');
    var svgcanvas = d3.select("body").append("svg:svg").attr("width", 1000).attr("height", 1000).attr("x","100");

    socket.on('full-git-log', function (full_git_log) {
      var dataset = full_git_log;
      var node_radius = 30;
      var group = svgcanvas.append("svg:g");

      // Binding & Adding the circles
      group.selectAll("circle").data(dataset)
        .enter().append("circle")
        .attr("r", node_radius)
        .attr("cy", function(d){ return (dataset.length-d.index) * 100 + 150;})
        .attr("cx", 300).style("fill", "steelblue");

      // Binding & Adding the rectangles (lines)
      group.selectAll("rect").data(dataset)
        .enter().append("rect")
        .attr("x",300)
        .attr("y",function(d){ return (dataset.length-d.index) * 100 + 185;})
        .attr("width", 3)
        .attr("height",30);
    });

    socket.on('test', function (dataset) {
      var svg = d3.select("body svg") ;
      var yValue = 100;

      // Set the base line for the t-coordinate of the svg group
      if (svgcanvas.select("g").attr("transform")!=null){
        //todo: find a clean way to get the past transform data, without using the split method
        yValue = parseInt(svgcanvas.select("g").attr("transform").split(",")[1].split(")")[0]) + 100 ;
      }

      // Did we remove data from the dataset?
      var toRemove = false;
      if (svgcanvas.select("g").selectAll("circle")[0].length > dataset.length){
        toRemove = true;
      }

      // Update the dataset for both circles and rectangles
      var circle = svgcanvas.select("g").selectAll("circle").data(dataset);
      var rect = svgcanvas.select("g").selectAll("rect").data(dataset);

      if (toRemove){
        // Fade out circle & remove it 
        circle.exit()
          .transition()
          .duration(1000) // this is 1s
          .delay(500)     // this is 0.1s
          .style("opacity","0").each("end", function() { circle.exit().remove(); });

        // Fade out rectangle & remove it  
        rect.exit()
          .transition()
          .duration(1000) // this is 1s
          .delay(500)     // this is 0.1s
          .style("opacity","0").each("end", function() { rect.exit().remove(); });

        // Move up teh group
        svgcanvas.select("g").transition()
          .duration(1000) // this is 1s
          .delay(500)     // this is 0.1s
        .attr("transform", "translate(0,"+yValue-100+")");

      } else {
        // Add new circle
        circle.enter()
          .append("circle")
          .transition()
          .duration(1000) // this is 1s
          .delay(500)     // this is 0.1s          
          .attr("cy", 50)
          .attr("cx", 300)
          .attr("r", 30)
          .style("fill", "green");

        // Add new rectangle
        rect.enter()
          .append("rect")
          .transition()
          .duration(1000) // this is 1s
          .delay(500)     // this is 0.1s           
          .attr("x",300)
          .attr("y",function(d){ return (dataset.length-d.index) * 100 + 85;})
          .attr("width", 3)
          .attr("height",30);
        // Move down all the group
        svgcanvas.select("g").transition()
          .duration(1000) // this is 1s
          .delay(500)     // this is 0.1s
          .attr("transform", "translate(0,"+yValue+")");
      }

    });


  </script>
  </body>
</html>